(function(b){var f=google.maps,a=new f.Geocoder,g=0,c={},c={init:function(e){var d,h=b.extend({},b.fn.gMap.defaults,e);for(d in b.fn.gMap.defaults.icon){h.icon[d]||(h.icon[d]=b.fn.gMap.defaults.icon[d])}return this.each(function(){var k=b(this),i=c._getMapCenter.apply(k,[h]);if(h.zoom=="fit"){h.zoom=c.autoZoom.apply(k,[h])}var l=new f.Map(this,{zoom:h.zoom,center:i,mapTypeControl:h.mapTypeControl,zoomControl:h.zoomControl,panControl:h.panControl,scaleControl:h.scaleControl,streetViewControl:h.streetViewControl,mapTypeId:h.maptype,scrollwheel:h.scrollwheel,maxZoom:h.maxZoom,minZoom:h.minZoom});h.log&&console.log("map center is:");h.log&&console.log(i);k.data("$gmap",l);k.data("gmap",{opts:h,gmap:l,markers:[],markerKeys:{},infoWindow:null});if(h.controls.length!==0){for(i=0;i<h.controls.length;i+=1){l.controls[h.controls[i].pos].push(h.controls[i].div)}}h.markers.length!==0&&c.addMarkers.apply(k,[h.markers]);c._onComplete.apply(k,[])})},_onComplete:function(){var e=this.data("gmap"),d=this;if(g!==0){window.setTimeout(function(){c._onComplete.apply(d,[])},1000)}else{e.opts.onComplete()}},_setMapCenter:function(e){var d=this.data("gmap");d.opts.log&&console.log("delayed setMapCenter called");if(d.gmap!==void 0){d.gmap.setCenter(e)}else{var h=this;window.setTimeout(function(){c._setMapCenter.apply(h,[e])},500)}},_boundaries:null,_getBoundaries:function(h){if(c._boundaries){return c._boundaries}var e=h.markers[0].latitude,m=h.markers[0].longitude,l=h.markers[0].longitude,k=h.markers[0].latitude,i;for(i=1;i<h.markers.length;i+=1){if(e>h.markers[i].latitude){e=h.markers[i].latitude}if(m<h.markers[i].longitude){m=h.markers[i].longitude}if(l>h.markers[i].longitude){l=h.markers[i].longitude}if(k<h.markers[i].latitude){k=h.markers[i].latitude}}c._boundaries={N:e,E:m,W:l,S:k};return c._boundaries},_getMapCenter:function(e){var d,j=this,h,i;if(e.markers.length&&(e.latitude=="fit"||e.longitude=="fit")){return d=c._getBoundaries(e),d=new f.LatLng((d.N+d.S)/2,(d.E+d.W)/2)}if(e.latitude&&e.longitude){return d=new f.LatLng(e.latitude,e.longitude)}else{d=new f.LatLng(0,0)}if(e.address){return a.geocode({address:e.address},function(k,l){l===google.maps.GeocoderStatus.OK?c._setMapCenter.apply(j,[k[0].geometry.location]):e.log&&console.log("Geocode was not successful for the following reason: "+l)}),d}if(e.markers.length>0){i=null;for(h=0;h<e.markers.length;h+=1){if(e.markers[h].setCenter){i=e.markers[h];break}}if(i===null){for(h=0;h<e.markers.length;h+=1){if(e.markers[h].latitude&&e.markers[h].longitude){i=e.markers[h];break}e.markers[h].address&&(i=e.markers[h])}}if(i===null){return d}if(i.latitude&&i.longitude){return new f.LatLng(i.latitude,i.longitude)}i.address&&a.geocode({address:i.address},function(k,l){l===google.maps.GeocoderStatus.OK?c._setMapCenter.apply(j,[k[0].geometry.location]):e.log&&console.log("Geocode was not successful for the following reason: "+l)})}return d},setZoom:function(e){var d=this.data("gmap").gmap;e==="fit"&&(e=c.autoZoom.apply(b(this),[]));d.setZoom(parseInt(e))},getRoute:function(t){var s=this.data("gmap"),r=s.gmap,o=new f.DirectionsRenderer,p=new f.DirectionsService,m={BYCAR:f.DirectionsTravelMode.DRIVING,BYBICYCLE:f.DirectionsTravelMode.BICYCLING,BYFOOT:f.DirectionsTravelMode.WALKING},n={MILES:f.DirectionsUnitSystem.IMPERIAL,KM:f.DirectionsUnitSystem.METRIC},q=null,i=null,d=null;t.routeDisplay!==void 0?q=t.routeDisplay instanceof jQuery?t.routeDisplay[0]:typeof t.routeDisplay=="string"?b(t.routeDisplay)[0]:null:s.opts.routeDisplay!==null&&(q=s.opts.routeDisplay instanceof jQuery?s.opts.routeDisplay[0]:typeof s.opts.routeDisplay=="string"?b(s.opts.routeDisplay)[0]:null);o.setMap(r);q!==null&&o.setPanel(q);i=m[s.opts.travelMode]!==void 0?m[s.opts.travelMode]:m.BYCAR;d=n[s.opts.travelUnit]!==void 0?n[s.opts.travelUnit]:n.KM;p.route({origin:t.from,destination:t.to,travelMode:i,unitSystem:d},function(e,h){h==f.DirectionsStatus.OK?o.setDirections(e):q!==null&&b(q).html(s.opts.routeErrors[h])});return this},processMarker:function(t,s,r,o){var p=this.data("gmap"),q=p.gmap,n=p.opts,m;o===void 0&&(o=new f.LatLng(t.latitude,t.longitude));if(!s){var j={image:n.icon.image,iconSize:new f.Size(n.icon.iconsize[0],n.icon.iconsize[1]),iconAnchor:new f.Point(n.icon.iconanchor[0],n.icon.iconanchor[1]),infoWindowAnchor:new f.Size(n.icon.infowindowanchor[0],n.icon.infowindowanchor[1])},s=new f.MarkerImage(j.image,j.iconSize,null,j.iconAnchor)}r||(new f.Size(n.icon.shadowsize[0],n.icon.shadowsize[1]),j&&j.iconAnchor||new f.Point(n.icon.iconanchor[0],n.icon.iconanchor[1]));m=new f.Marker({position:o,icon:s,title:t.title,map:q});m.setShadow(r);p.markers.push(m);t.key&&(p.markerKeys[t.key]=m);var d;t.html&&(s={content:typeof t.html==="string"?n.html_prepend+t.html+n.html_append:t.html,pixelOffset:t.infoWindowAnchor},n.log&&console.log("setup popup with data"),n.log&&console.log(s),d=new f.InfoWindow(s),f.event.addListener(m,"click",function(){n.log&&console.log("opening popup "+t.html);n.singleInfoWindow&&p.infoWindow&&p.infoWindow.close();d.open(q,m);p.infoWindow=d}));if(t.html&&t.popup){n.log&&console.log("opening popup "+t.html),d.open(q,m),p.infoWindow=d}},_geocodeMarker:function(e,d,i){g+=1;var h=this;a.geocode({address:e.address},function(l,k){g-=1;k===f.GeocoderStatus.OK?(h.data("gmap").opts.log&&console.log("Geocode was successful with point: ",l[0].geometry.location),c.processMarker.apply(h,[e,d,i,l[0].geometry.location])):h.data("gmap").opts.log&&console.log("Geocode was not successful for the following reason: "+k)})},autoZoom:function(h){var e=this.data("gmap"),j,i=39135.758482,h=e?e.opts:h;h.log&&console.log("autozooming map");e=c._getBoundaries(h);h=(e.E-e.W)*111000/this.width();j=(e.S-e.N)*111000/this.height();for(e=2;e<20;e+=1){if(h>i||j>i){break}i/=2}return e-2},addMarkers:function(e){var d=this.data("gmap").opts;if(e.length!==0){d.log&&console.log("adding "+e.length+" markers");for(d=0;d<e.length;d+=1){c.addMarker.apply(b(this),[e[d]])}}return this},addMarker:function(r){var q=this.data("gmap").opts;q.log&&console.log("putting marker at "+r.latitude+", "+r.longitude+" with address "+r.address+" and html "+r.html);var p=q.icon.image,n=new f.Size(q.icon.iconsize[0],q.icon.iconsize[1]),o=new f.Point(q.icon.iconanchor[0],q.icon.iconanchor[1]),e=new f.Size(q.icon.infowindowanchor[0],q.icon.infowindowanchor[1]),m=q.icon.shadow,l=new f.Size(q.icon.shadowsize[0],q.icon.shadowsize[1]),d=o;r.infoWindowAnchor=e;if(r.icon){if(r.icon.image){p=r.icon.image}r.icon.iconsize&&(n=new f.Size(r.icon.iconsize[0],r.icon.iconsize[1]));r.icon.iconanchor&&(o=new f.Point(r.icon.iconanchor[0],r.icon.iconanchor[1]));r.icon.infowindowanchor&&new f.Size(r.icon.infowindowanchor[0],r.icon.infowindowanchor[1]);if(r.icon.shadow){m=r.icon.shadow}r.icon.shadowsize&&(l=new f.Size(r.icon.shadowsize[0],r.icon.shadowsize[1]))}p=new f.MarkerImage(p,n,null,o);m=new f.MarkerImage(m,l,null,d);if(r.address){if(r.html==="_address"){r.html=r.address}if(r.title=="_address"){r.title=r.address}q.log&&console.log("geocoding marker: "+r.address);c._geocodeMarker.apply(this,[r,p,m])}else{if(r.html==="_latlng"){r.html=r.latitude+", "+r.longitude}if(r.title=="_latlng"){r.title=r.latitude+", "+r.longitude}q=new f.LatLng(r.latitude,r.longitude);c.processMarker.apply(this,[r,p,m,q])}return this},removeAllMarkers:function(){var e=this.data("gmap").markers,d;for(d=0;d<e.length;d+=1){e[d].setMap(null),delete e[d]}e.length=0},getMarker:function(d){return this.data("gmap").markerKeys[d]}};b.fn.gMap=function(d){if(c[d]){return c[d].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof d==="object"||!d){return c.init.apply(this,arguments)}else{b.error("Method "+d+" does not exist on jQuery.gmap")}}};b.fn.gMap.defaults={log:!1,address:"",latitude:null,longitude:null,zoom:3,maxZoom:null,minZoom:null,markers:[],controls:{},scrollwheel:!0,maptype:google.maps.MapTypeId.ROADMAP,mapTypeControl:!0,zoomControl:!0,panControl:!1,scaleControl:!1,streetViewControl:!0,singleInfoWindow:!0,html_prepend:'<div class="gmap_marker">',html_append:"</div>",icon:{image:"http://www.google.com/mapfiles/marker.png",iconsize:[20,34],iconanchor:[9,34],infowindowanchor:[9,2],shadow:"http://www.google.com/mapfiles/shadow50.png",shadowsize:[37,34]},onComplete:function(){},travelMode:"BYCAR",travelUnit:"KM",routeDisplay:null,routeErrors:{INVALID_REQUEST:"The provided request is invalid.",NOT_FOUND:"One or more of the given addresses could not be found.",OVER_QUERY_LIMIT:"A temporary error occured. Please try again in a few minutes.",REQUEST_DENIED:"An error occured. Please contact us.",UNKNOWN_ERROR:"An unknown error occured. Please try again.",ZERO_RESULTS:"No route could be found within the given addresses."}}})(jQuery);